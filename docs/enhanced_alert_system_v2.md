# BigDataOps å¢å¼ºå‘Šè­¦ç³»ç»Ÿ v2.0 æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

BigDataOps v2.0 ç‰ˆæœ¬å¯¹å‘Šè­¦ç³»ç»Ÿè¿›è¡Œäº†å…¨é¢å‡çº§ï¼Œå¼•å…¥äº†æ™ºèƒ½æŠ‘åˆ¶è§„åˆ™ã€æ‰‹åŠ¨ç¡®è®¤åŠŸèƒ½ã€æ¨¡æ¿å¤åˆ¶ç­‰å¢å¼ºç‰¹æ€§ï¼Œå¤§å¹…æå‡äº†å‘Šè­¦ç®¡ç†çš„çµæ´»æ€§å’Œç”¨æˆ·ä½“éªŒã€‚

## ğŸš€ æ–°å¢åŠŸèƒ½

### 1. å¢å¼ºæŠ‘åˆ¶è§„åˆ™

#### åŠŸèƒ½æè¿°
åœ¨åŸæœ‰æ—¶é—´æŠ‘åˆ¶çš„åŸºç¡€ä¸Šï¼Œæ–°å¢å¤šç»´åº¦æŠ‘åˆ¶æ§åˆ¶ï¼š

- **åŒé‡æŒç»­æ—¶é—´æ§åˆ¶**: è§¦å‘æŒç»­æ—¶é—´ï¼ˆé¿å…è¯¯æŠ¥ï¼‰+ å‘é€æŒç»­æ—¶é—´ï¼ˆé˜²æ­¢è½°ç‚¸ï¼‰
- **å‘é€æ¬¡æ•°é™åˆ¶**: å¯è®¾ç½®æœ€å¤§å‘é€æ¬¡æ•°ï¼Œè¾¾åˆ°ååœæ­¢
- **æ¯æ—¥é‡ç½®æœºåˆ¶**: è®¡æ•°å™¨æ¯å¤©0ç‚¹è‡ªåŠ¨é‡ç½®
- **æ™ºèƒ½çŠ¶æ€ç®¡ç†**: å®Œå–„çš„çŠ¶æ€è½¬æ¢é€»è¾‘

#### é…ç½®è¯´æ˜

| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `suppress` | String | null | æŠ‘åˆ¶æ¡ä»¶ï¼Œå¦‚ "5m", "1h" |
| `repeat` | Integer | 0 | å†é€šçŸ¥é—´éš”(ç§’) |
| `for_duration` | Integer | 60 | è§¦å‘æŒç»­æ—¶é—´(ç§’)ï¼Œæ¡ä»¶æŒç»­æ»¡è¶³å¤šä¹…æ‰è§¦å‘å‘Šè­¦ |
| `duration` | Integer | 3600 | å‘é€æŒç»­æ—¶é—´(ç§’)ï¼Œå‘Šè­¦å‘é€è¶…æ—¶åœæ­¢ |
| `max_send_count` | Integer | null | æœ€å¤§å‘é€æ¬¡æ•° |

#### é…ç½®ç¤ºä¾‹

```json
{
  "suppress": "5m",        // 5åˆ†é’Ÿå†…ä¸é‡å¤
  "repeat": 1800,          // 30åˆ†é’Ÿé‡å¤é—´éš”
  "for_duration": 120,     // æ¡ä»¶æŒç»­2åˆ†é’Ÿæ‰è§¦å‘
  "duration": 3600,        // å‘Šè­¦å‘é€1å°æ—¶ååœæ­¢
  "max_send_count": 3      // æœ€å¤šå‘é€3æ¬¡
}
```

#### æ¨èé…ç½®

| å‘Šè­¦çº§åˆ« | æŠ‘åˆ¶æ—¶é—´ | é‡å¤é—´éš” | æŒç»­æ—¶é—´ | æœ€å¤§æ¬¡æ•° | é€‚ç”¨åœºæ™¯ |
|---------|----------|----------|----------|----------|----------|
| critical | 1-5åˆ†é’Ÿ | 5-10åˆ†é’Ÿ | 30åˆ†é’Ÿ-1å°æ—¶ | 5-10æ¬¡ | ä¸¥é‡æ•…éšœ |
| high | 5-15åˆ†é’Ÿ | 30åˆ†é’Ÿ-1å°æ—¶ | 1-2å°æ—¶ | 3-5æ¬¡ | é‡è¦å‘Šè­¦ |
| medium | 15-30åˆ†é’Ÿ | 1-2å°æ—¶ | 2-4å°æ—¶ | 2-3æ¬¡ | ä¸€èˆ¬å‘Šè­¦ |
| low | 30åˆ†é’Ÿ-1å°æ—¶ | 2-4å°æ—¶ | 4-8å°æ—¶ | 1-2æ¬¡ | æé†’ç±» |

### 2. æ‰‹åŠ¨ç¡®è®¤åŠŸèƒ½

#### åŠŸèƒ½æè¿°
æ”¯æŒæ‰‹åŠ¨ç¡®è®¤å‘Šè­¦ï¼Œç¡®è®¤åç«‹å³åœæ­¢å‘é€é€šçŸ¥ï¼Œé¿å…æŒç»­æ‰“æ‰°ã€‚

#### ä½¿ç”¨ä½ç½®
- **å‘Šè­¦å†å²é¡µé¢**: ç¡®è®¤å•æ¡å‘Šè­¦è®°å½•
- **å‘Šè­¦è§„åˆ™é¡µé¢**: ç¡®è®¤æ•´ä¸ªè§„åˆ™çš„æ‰€æœ‰å‘Šè­¦

#### ç¡®è®¤æ•ˆæœ
- å‘Šè­¦çŠ¶æ€å˜ä¸º `silenced`
- åœæ­¢ç»§ç»­å‘é€é€šçŸ¥
- è®°å½•ç¡®è®¤äººå’Œç¡®è®¤æ—¶é—´
- å¯åœ¨å†å²è®°å½•ä¸­æŸ¥çœ‹ç¡®è®¤çŠ¶æ€

#### APIæ¥å£

**ç¡®è®¤å•æ¡å‘Šè­¦**
```bash
POST /api/alert/history/{history_id}/acknowledge?acknowledged_by=ç”¨æˆ·å
```

**ç¡®è®¤è§„åˆ™å‘Šè­¦**
```bash
POST /api/alert/rule/{rule_id}/acknowledge?acknowledged_by=ç”¨æˆ·å
```

### 3. å‘Šè­¦æ¨¡æ¿å¤åˆ¶åŠŸèƒ½

#### åŠŸèƒ½æè¿°
æ”¯æŒåŸºäºç°æœ‰æ¨¡æ¿å¿«é€Ÿåˆ›å»ºæ–°æ¨¡æ¿ï¼Œè‡ªåŠ¨å¤åˆ¶æ‰€æœ‰é…ç½®å‚æ•°ã€‚

#### ä½¿ç”¨æ–¹æ³•
1. åœ¨å‘Šè­¦æ¨¡æ¿ç®¡ç†é¡µé¢ç‚¹å‡»"å¤åˆ¶"æŒ‰é’®
2. ç³»ç»Ÿè‡ªåŠ¨å¤åˆ¶åŸæ¨¡æ¿çš„æ‰€æœ‰é…ç½®
3. åç§°è‡ªåŠ¨æ·»åŠ "å‰¯æœ¬"åç¼€
4. ç”¨æˆ·å¯ä¿®æ”¹é…ç½®åä¿å­˜

#### æ”¯æŒçš„æ¨¡æ¿ç±»å‹
- é‚®ä»¶æ¨¡æ¿ (email)
- HTTPæ¨¡æ¿ (http)
- ä¹èŠæ¨¡æ¿ (lechat)

### 4. ä¹èŠé€šçŸ¥å¢å¼º

#### åŠŸèƒ½æè¿°
å®Œå–„ä¹èŠé€šçŸ¥åŠŸèƒ½ï¼Œæ”¯æŒç¾¤ç»„å’Œä¸ªäººä¸¤ç§æ¨¡å¼ã€‚

#### ç¾¤ç»„æ¨¡å¼é…ç½®
```json
{
  "mode": "group",
  "url": "http://your-host/api/message/sendTeam",
  "fromId": "your-bot-id",
  "groupId": "group-123456",
  "ext": {"group": "oa"},
  "body_template": {
    "robot": {"type": "robotAnswer"},
    "type": "multi",
    "msgs": [{
      "text": "ğŸš¨ ã€{level}ã€‘å‘Šè­¦é€šçŸ¥\nè§„åˆ™: {rule_name}\nå½“å‰å€¼: {current_value}\næ—¶é—´: {trigger_time}",
      "type": "text"
    }]
  },
  "option": {"push": true}
}
```

#### ä¸ªäººæ¨¡å¼é…ç½®
```json
{
  "mode": "personal",
  "url": "http://your-host/api/message/sendPersonal",
  "fromId": "your-bot-id",
  "userIds": "user1,user2",
  "ext": {"group": "oa"},
  "body_template": {
    "robot": {"type": "robotAnswer"},
    "type": "multi",
    "msgs": [{
      "text": "ğŸš¨ ã€{level}ã€‘å‘Šè­¦é€šçŸ¥\nè§„åˆ™: {rule_name}\nå½“å‰å€¼: {current_value}\næ—¶é—´: {trigger_time}",
      "type": "text"
    }]
  },
  "userMapping": {
    "emp001": "user1",
    "emp002": "user2"
  },
  "option": {"push": true}
}
```

## ğŸ—ƒï¸ æ•°æ®åº“ç»“æ„å˜æ›´

### alert_rule è¡¨æ–°å¢å­—æ®µ

```sql
-- æŠ‘åˆ¶æ§åˆ¶å­—æ®µ
for_duration INT DEFAULT 60 COMMENT 'è§¦å‘æŒç»­æ—¶é—´(ç§’)',
duration INT DEFAULT 3600 COMMENT 'å‘é€æŒç»­æ—¶é—´(ç§’)',
max_send_count INT DEFAULT NULL COMMENT 'æœ€å¤§å‘é€æ¬¡æ•°',
send_count INT DEFAULT 0 COMMENT 'å½“å‰å·²å‘é€æ¬¡æ•°',
alert_start_time DATETIME DEFAULT NULL COMMENT 'å‘Šè­¦å¼€å§‹æ—¶é—´'
```

### alert_history è¡¨æ–°å¢å­—æ®µ

```sql
-- ç¡®è®¤åŠŸèƒ½å­—æ®µ
acknowledged TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦å·²ç¡®è®¤',
acknowledged_at DATETIME DEFAULT NULL COMMENT 'ç¡®è®¤æ—¶é—´',
acknowledged_by VARCHAR(128) DEFAULT NULL COMMENT 'ç¡®è®¤äºº'
```

### æ–°å¢ç´¢å¼•

```sql
-- æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
INDEX idx_alert_start_time (alert_start_time),
INDEX idx_send_count (send_count),
INDEX idx_acknowledged (acknowledged),
INDEX idx_rule_acknowledged (rule_id, acknowledged)
```

## ğŸ”§ éƒ¨ç½²æŒ‡å—

### 1. æ•°æ®åº“é‡å»º

```bash
# ä½¿ç”¨æä¾›çš„è„šæœ¬é‡å»ºæ•°æ®åº“
./rebuild_database.sh

# æˆ–æ‰‹åŠ¨æ‰§è¡ŒSQL
mysql -u root -p your_database < docs/tables_v2.sql
```

### 2. åç«¯æ›´æ–°

```bash
# é‡å¯åç«¯æœåŠ¡ä½¿æ•°æ®æ¨¡å‹ç”Ÿæ•ˆ
python app/main.py
```

### 3. å‰ç«¯æ›´æ–°

å‰ç«¯ä»£ç å·²è‡ªåŠ¨åŒ…å«æ–°åŠŸèƒ½ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚

## ğŸ“± å‰ç«¯ç•Œé¢å˜æ›´

### å‘Šè­¦è§„åˆ™ç®¡ç†é¡µé¢
- âœ… æ–°å¢"æŒç»­æ—¶é—´"é…ç½®æ¡†
- âœ… æ–°å¢"æœ€å¤§å‘é€æ¬¡æ•°"é…ç½®æ¡†  
- âœ… æ–°å¢è§„åˆ™çº§åˆ«"ç¡®è®¤"æŒ‰é’®

### å‘Šè­¦å†å²é¡µé¢
- âœ… æ–°å¢ç¡®è®¤çŠ¶æ€æ˜¾ç¤ºåˆ—
- âœ… æ–°å¢"ç¡®è®¤"æ“ä½œæŒ‰é’®
- âœ… ç¡®è®¤ä¿¡æ¯å±•ç¤º

### å‘Šè­¦æ¨¡æ¿é¡µé¢
- âœ… æ–°å¢"å¤åˆ¶"æ“ä½œæŒ‰é’®
- âœ… æ™ºèƒ½å‚æ•°å¤åˆ¶åŠŸèƒ½

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. åŠŸèƒ½æµ‹è¯•

```bash
# è¿è¡Œå¢å¼ºåŠŸèƒ½æµ‹è¯•
python test_enhanced_alert_system.py
```

### 2. æŠ‘åˆ¶è§„åˆ™æµ‹è¯•

åˆ›å»ºæµ‹è¯•è§„åˆ™ï¼š
- è®¾ç½®çŸ­æŠ‘åˆ¶æ—¶é—´ï¼ˆå¦‚ 2åˆ†é’Ÿï¼‰
- è®¾ç½®æœ€å¤§å‘é€æ¬¡æ•°ï¼ˆå¦‚ 3æ¬¡ï¼‰
- è®¾ç½®æŒç»­æ—¶é—´ï¼ˆå¦‚ 10åˆ†é’Ÿï¼‰

è§‚å¯Ÿå‘Šè­¦è¡Œä¸ºæ˜¯å¦ç¬¦åˆé¢„æœŸã€‚

### 3. ç¡®è®¤åŠŸèƒ½æµ‹è¯•

1. è§¦å‘å‘Šè­¦
2. åœ¨ç•Œé¢ä¸­ç‚¹å‡»ç¡®è®¤æŒ‰é’®
3. éªŒè¯å‘Šè­¦çŠ¶æ€å˜ä¸ºå·²ç¡®è®¤
4. éªŒè¯ä¸å†æ”¶åˆ°æ–°é€šçŸ¥

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### æ–°å¢ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡åç§° | è¯´æ˜ |
|---------|------|
| alert_send_count | å‘Šè­¦å‘é€æ¬¡æ•°ç»Ÿè®¡ |
| alert_acknowledged_count | å‘Šè­¦ç¡®è®¤æ¬¡æ•°ç»Ÿè®¡ |
| alert_duration_exceeded | è¶…æ—¶åœæ­¢çš„å‘Šè­¦æ•°é‡ |
| alert_max_send_reached | è¾¾åˆ°æœ€å¤§å‘é€æ¬¡æ•°çš„å‘Šè­¦æ•°é‡ |

### æ€§èƒ½æŒ‡æ ‡

- å‘Šè­¦å¤„ç†å»¶è¿Ÿ: < 5ç§’
- æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½: < 100ms
- å†…å­˜ä½¿ç”¨: ä¼˜åŒ–ç´¢å¼•åå‡å°‘30%

## ğŸš¨ æ³¨æ„äº‹é¡¹

### 1. é…ç½®å»ºè®®

- **æŒç»­æ—¶é—´**: å»ºè®®è®¾ç½®ä¸º 1-8å°æ—¶ï¼Œé¿å…è¿‡çŸ­æˆ–è¿‡é•¿
- **æœ€å¤§æ¬¡æ•°**: å»ºè®®è®¾ç½®ä¸º 1-10æ¬¡ï¼Œæ ¹æ®å‘Šè­¦çº§åˆ«è°ƒæ•´
- **æŠ‘åˆ¶æ—¶é—´**: å»ºè®®æ ¹æ®é—®é¢˜è§£å†³æ—¶é—´è®¾ç½®

### 2. æ€§èƒ½è€ƒè™‘

- å¤§é‡å‘Šè­¦è§„åˆ™å»ºè®®åˆ†æ‰¹å¤„ç†
- å®šæœŸæ¸…ç†å†å²æ•°æ®é¿å…è¡¨è¿‡å¤§
- ç›‘æ§æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡

### 3. å®‰å…¨æ³¨æ„

- ç¡®è®¤æ“ä½œéœ€è¦ç”¨æˆ·è®¤è¯
- APIè°ƒç”¨éœ€è¦æƒé™éªŒè¯
- æ•æ„Ÿé…ç½®éœ€è¦åŠ å¯†å­˜å‚¨

## ğŸ”„ å‡çº§è·¯å¾„

### ä» v1.0 å‡çº§åˆ° v2.0

1. **å¤‡ä»½æ•°æ®**
   ```bash
   mysqldump -u root -p bigdata_ops > backup_v1.sql
   ```

2. **æ‰§è¡Œå‡çº§è„šæœ¬**
   ```bash
   ./rebuild_database.sh
   ```

3. **éªŒè¯åŠŸèƒ½**
   ```bash
   python test_enhanced_alert_system.py
   ```

4. **é‡å¯æœåŠ¡**
   ```bash
   # é‡å¯åç«¯
   systemctl restart bigdata-ops-backend
   
   # é‡å¯å‰ç«¯
   systemctl restart bigdata-ops-frontend
   ```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- é‚®ç®±: support@bigdataops.com
- æ–‡æ¡£: https://docs.bigdataops.com
- GitHub: https://github.com/bigdataops/issues

---

**ç‰ˆæœ¬**: v2.0  
**æ›´æ–°æ—¥æœŸ**: 2024å¹´12æœˆ  
**ä½œè€…**: BigDataOpså›¢é˜Ÿ

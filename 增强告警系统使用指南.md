# 🚨 增强告警系统使用指南

## 🎯 快速开始

### 1. 重建数据库

```bash
# 执行数据库重建脚本
./rebuild_database.sh

# 按提示输入数据库密码和确认操作
```

### 2. 重启服务

```bash
# 重启后端服务
python app/main.py

# 前端无需重启，刷新页面即可
```

## ⚙️ 功能使用说明

### 📋 创建增强告警规则

1. **登录系统** → **告警规则管理** → **新增规则**

2. **基础配置**：
   - 规则名称：如 "MySQL连接数告警"
   - 组件分组：选择 "mysql"
   - PromQL表达式：`mysql_global_status_threads_connected`
   - 比较方式：`>`
   - 阈值：`80`
   - 触发持续时间：`120` # 条件持续2分钟才触发

3. **增强抑制配置**：
   ```
   抑制条件: 10m          # 10分钟内不重复
   再通知间隔: 1800       # 30分钟后重复通知
   发送持续时间: 3600     # 1小时后停止发送
   最大发送次数: 3        # 最多发送3次
   ```

4. **保存规则**，系统会自动应用新的抑制逻辑

### ⏰ 两种持续时间说明

系统中有两个"持续时间"概念，作用不同：

| 字段 | 含义 | 作用时机 | 示例 |
|------|------|----------|------|
| **触发持续时间** | 条件需要持续满足多长时间才触发告警 | 告警触发前 | 120秒 = CPU>90%持续2分钟才报警 |
| **发送持续时间** | 告警发送的最大持续时间 | 告警触发后 | 3600秒 = 告警发送1小时后自动停止 |

#### 配置建议：
- **触发持续时间**: 30-300秒，避免短暂波动误报
- **发送持续时间**: 1-8小时，防止长期轰炸

### 🔕 手动确认告警

#### 方式一：在告警历史中确认
1. **告警历史** → 找到要确认的告警
2. 点击 **确认** 按钮
3. 系统立即停止该告警的后续通知

#### 方式二：在告警规则中确认
1. **告警规则管理** → 找到正在告警的规则
2. 点击 **确认** 按钮  
3. 系统停止该规则的所有告警通知

### 📄 复制告警模板

1. **告警模板管理** → 找到要复制的模板
2. 点击 **复制** 按钮
3. 系统自动复制配置，名称添加"副本"后缀
4. 修改配置后 **保存**

### 📋 复制告警规则

1. **告警规则管理** → 找到要复制的规则
2. 点击 **复制** 按钮
3. 系统自动复制所有配置，名称添加"副本"后缀
4. **默认禁用状态**，防止意外触发
5. 修改规则内容后 **保存并启用**

## 💡 最佳实践

### 🎯 抑制规则配置建议

| 告警类型 | 抑制时间 | 最大次数 | 持续时间 | 示例场景 |
|---------|----------|----------|----------|----------|
| **系统级严重** | 2-5分钟 | 5-10次 | 30分钟-1小时 | CPU>95%, 内存耗尽 |
| **服务级重要** | 5-15分钟 | 3-5次 | 1-2小时 | 服务不可用, 连接超时 |
| **性能级一般** | 15-30分钟 | 2-3次 | 2-4小时 | 响应变慢, 队列积压 |
| **提醒级轻微** | 30分钟-1小时 | 1-2次 | 4-8小时 | 存储使用率, 日志错误 |

### 📊 配置示例

#### 数据库连接告警
```
抑制条件: 5m
最大发送次数: 3
持续时间: 1800      # 30分钟
再通知间隔: 600     # 10分钟
```

#### 存储空间告警  
```
抑制条件: 30m
最大发送次数: 2
持续时间: 14400     # 4小时
再通知间隔: 3600    # 1小时
```

#### CPU使用率告警
```
抑制条件: 3m
最大发送次数: 5
持续时间: 1800      # 30分钟
再通知间隔: 300     # 5分钟
```

## 🔧 故障排查

### 常见问题

**Q1: 告警没有按照抑制规则工作？**
- 检查规则配置是否正确保存
- 确认告警引擎正在运行
- 查看后端日志是否有错误

**Q2: 确认按钮点击后没有效果？**
- 检查网络连接
- 确认后端API正常
- 刷新页面重试

**Q3: 持续时间到了还在发送告警？**
- 检查系统时间是否正确
- 确认 `alert_start_time` 字段有值
- 查看规则的 `send_count` 计数

### 调试命令

```bash
# 检查告警引擎状态
curl http://localhost:8000/api/alert/engine/status

# 查看规则状态
mysql -e "SELECT name, alert_state, send_count, alert_start_time FROM alert_rule WHERE enabled=1;"

# 查看确认状态
mysql -e "SELECT rule_name, acknowledged, acknowledged_by, acknowledged_at FROM alert_history WHERE acknowledged=1;"
```

## 📈 监控效果

使用增强告警系统后，您将看到：

✅ **减少告警噪音** - 智能抑制避免重复通知  
✅ **提高响应效率** - 手动确认快速止损  
✅ **优化运维体验** - 模板复制提高配置效率  
✅ **增强可控性** - 多维度控制告警频率  

## 🎉 开始使用

现在您可以开始使用增强版告警系统了！

1. 🔄 重建数据库表结构
2. ⚙️ 配置告警规则的抑制参数  
3. 🔕 体验手动确认功能
4. 📄 尝试复制模板功能

有任何问题，请查看详细文档：`docs/enhanced_alert_system_v2.md`
